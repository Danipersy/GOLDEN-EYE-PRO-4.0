name: ğŸš€ Deploy Golden Eye Pro

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # Permette di lanciare manualmente

jobs:
  test:
    name: ğŸ§ª Test e Validazione
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v3

    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        cache: 'pip'

    - name: ğŸ“¦ Installa dipendenze
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov flake8 black

    - name: ğŸ” Verifica struttura file
      run: |
        echo "ğŸ“ Verifica directory necessarie..."
        required_dirs=("ui_streamlit" "providers" "indicators" "strategy" "utils" "ai" "storage")
        for dir in "${required_dirs[@]}"; do
          if [ -d "$dir" ]; then
            echo "âœ… $dir - OK"
          else
            echo "âŒ $dir - MANCANTE"
            exit 1
          fi
        done

    - name: ğŸ“„ Verifica file essenziali
      run: |
        echo "ğŸ“„ Verifica file principali..."
        required_files=("App.py" "config.py" "requirements.txt")
        for file in "${required_files[@]}"; do
          if [ -f "$file" ]; then
            echo "âœ… $file - OK"
          else
            echo "âŒ $file - MANCANTE"
            exit 1
          fi
        done

    - name: ğŸ§ª Test importazioni
      run: |
        echo "ğŸ”Œ Test importazioni critiche..."
        python -c "
import sys
print('Testing imports...')
modules = [
    'config',
    'providers.base_provider',
    'providers.twelvedata_provider',
    'providers.multi_provider',
    'indicators.robust_ta',
    'strategy.backtest',
    'utils.helpers',
    'ai.asset_analyzer'
]
for module in modules:
    try:
        __import__(module)
        print(f'âœ… {module}')
    except Exception as e:
        print(f'âŒ {module}: {e}')
        sys.exit(1)
print('âœ… Tutte le importazioni OK')
"

    - name: ğŸ¨ Controllo stile codice
      run: |
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        black --check . || echo "âš ï¸ Black formattazione consigliata"

    - name: ğŸ” Verifica secrets template
      run: |
        if [ -f ".streamlit/secrets.toml" ]; then
          echo "âš ï¸ ATTENZIONE: secrets.toml presente nel repository!"
          echo "âŒ Rimuovilo immediatamente! Usa GitHub Secrets invece."
          exit 1
        else
          echo "âœ… secrets.toml non presente (OK)"
        fi

  security:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v3

    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: ğŸ” Scan dipendenze vulnerabili
      run: |
        pip install safety
        safety check -r requirements.txt || echo "âš ï¸ Verifica manuale consigliata"

    - name: ğŸ” Bandit security scan
      run: |
        pip install bandit
        bandit -r . -f custom -c "bandit.yaml" || echo "âš ï¸ Bandit ha trovato possibili issues"

  deploy:
    name: â˜ï¸ Deploy su Streamlit Cloud
    runs-on: ubuntu-latest
    needs: [test, security]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v3

    - name: ğŸš€ Trigger Streamlit Cloud Deploy
      env:
        STREAMLIT_API_KEY: ${{ secrets.STREAMLIT_API_KEY }}
        REPO_NAME: ${{ github.repository }}
      run: |
        echo "ğŸ“¡ Avvio deploy su Streamlit Cloud..."
        curl -X POST \
          -H "Authorization: Bearer $STREAMLIT_API_KEY" \
          -H "Content-Type: application/json" \
          -d '{"git": {"repository": "'$REPO_NAME'", "branch": "main"}}' \
          https://api.streamlit.io/v1/deploy || echo "âš ï¸ Usa deploy manuale"

    - name: âœ… Verifica deploy
      run: |
        echo "ğŸ‰ Deploy completato!"
        echo "ğŸŒ App disponibile a: https://${{ github.repository_owner }}-golden-eye-pro.streamlit.app"

  notify:
    name: ğŸ“¢ Notifica
    runs-on: ubuntu-latest
    needs: [deploy]
    if: success()
    
    steps:
    - name: ğŸ’¬ Notifica Telegram
      uses: appleboy/telegram-action@master
      with:
        to: ${{ secrets.TELEGRAM_CHAT_ID }}
        token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        message: |
          âœ… **Golden Eye Pro Deploy Riuscito!**
          
          ğŸ“¦ Repository: ${{ github.repository }}
          ğŸ“ Commit: ${{ github.event.head_commit.message }}
          ğŸ‘¤ Author: ${{ github.event.head_commit.author.name }}
          ğŸ”— URL: https://github.com/${{ github.repository }}/commit/${{ github.sha }}
          
          ğŸŒ **App Live:** https://${{ github.repository_owner }}-golden-eye-pro.streamlit.app
