name: Test Golden Eye Pro

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Setup Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'  # IMPORTANTE: 3.11, non 3.10!
          cache: 'pip'
      
      - name: Display Python version
        run: |
          python --version
          python -c "import sys; print(f'Python {sys.version}')"
      
      - name: Upgrade pip
        run: |
          python -m pip install --upgrade pip
          pip install --upgrade setuptools wheel
      
      - name: Install dependencies
        run: |
          # Prima installa pandas_ta da solo
          pip install pandas_ta
          
          # Poi installa tutto il resto
          pip install -r requirements.txt
      
      - name: Verify installations
        run: |
          python -c "
import sys
print('ğŸ“¦ Verifica pacchetti installati:')
try:
    import pandas_ta
    print(f'âœ… pandas_ta {pandas_ta.__version__}')
except Exception as e:
    print(f'âŒ pandas_ta: {e}')
    sys.exit(1)

try:
    import streamlit
    print(f'âœ… streamlit {streamlit.__version__}')
except: pass

try:
    import pandas
    print(f'âœ… pandas {pandas.__version__}')
except: pass

print('ğŸ‰ Tutti i test superati!')
"
      
      - name: Test application imports
        run: |
          python -c "
import sys
sys.path.insert(0, '.')
try:
    import config
    print('âœ… config.py OK')
    
    from providers.base_provider import BaseProvider
    print('âœ… providers OK')
    
    print('ğŸ‰ Applicazione pronta per il deploy!')
except Exception as e:
    print(f'âŒ Errore: {e}')
    sys.exit(1)
"
      
      - name: Create cache directories
        run: |
          mkdir -p cache
          mkdir -p cache/twelvedata
          mkdir -p cache/yahoo
          mkdir -p .streamlit
          echo "âœ… Cache directories created"
      
      - name: Create secrets template (safe)
        run: |
          cat > .streamlit/secrets.toml << 'EOF'
# Template secrets - NON COMMITTARE CHIAVI REALI!
# Inserisci le tue chiavi su Streamlit Cloud
TWELVEDATA_KEY = ""
ALPHA_VANTAGE_KEY = ""
MARKETAUX_TOKEN = ""
EOF
          echo "âœ… Secrets template created (safe for commit)"
      
      - name: Summary
        run: |
          echo "================================"
          echo "âœ…âœ…âœ… TEST COMPLETATI âœ…âœ…âœ…"
          echo "================================"
          echo "ğŸŒ Ora puoi fare deploy su Streamlit Cloud"
          echo "ğŸ“Š App: https://${{ github.repository_owner }}-golden-eye-pro.streamlit.app"
